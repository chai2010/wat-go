# wat-go: WebAssembly文本格式工具

目标不是解析完整的 wat 语法, 而是能满足wat-go输出的 wat 格式.

安装: `go install github.com/chai2010/wat-go@master`

## Wat 格式的子集

- 函数指令不支持折叠
- 只支持行注释, 不支持多行块注释
- 每个指令一行, 单指令之间不会出现行注释
- 对象前出现的是关联注释, 其他注释全部丢弃
- 转义字符串扩展: '\n', '\r', '\t', '\\', '\"'

## 例子：Fib

hello.wat:

```wat
(module
  (func $fib (export "fib") (param $n i64) (result i64)
    local.get $n
    i64.const 2
    i64.le_u
    if
      i64.const 1
      return
    end
    local.get $n
    i64.const 1
    i64.sub
    call $fib
    local.get $n
    i64.const 2
    i64.sub
    call $fib
    i64.add
  )
)
```

输入以下命令转为C语言代码:

```
$ wat-go 2c fib.wat
```

输出的`_a.out.c`内容如下:

```c
// Auto Generated by https://github.com/chai2010/wat-go. DONOT EDIT!!!

#include <stdint.h>
#include <string.h>
#include <math.h>

typedef uint8_t   u8_t;
typedef int8_t    i8_t;
typedef uint16_t  u16_t;
typedef int16_t   i16_t;
typedef uint32_t  u32_t;
typedef int32_t   i32_t;
typedef uint64_t  u64_t;
typedef int64_t   i64_t;
typedef float     f32_t;
typedef double    f64_t;
typedef uintptr_t ref_t;

typedef union val_t {
  i64_t i64;
  f64_t f64;
  i32_t i32;
  f32_t f32;
  ref_t ref;
} val_t;

// func $fib (param $n i64) (result i64)
static i64_t fn_fib(i64_t n);

// func fib (param $n i64) (result i64)
static i64_t fn_fib(i64_t n) {
  u32_t $R_u32;
  u16_t $R_u16;
  u8_t  $R_u8;
  val_t $R0, $R1, $R2;

  $R0.i64 = n;
  $R1.i64 = 2;
  $R0.i32 = ((u64_t)($R0.i64)<=(u64_t)($R1.i64))? 1: 0;
  if($R0.i32) {
    $R0.i64 = 1;
    return $R0.i64;
  }
  $R0.i64 = n;
  $R1.i64 = 1;
  $R0.i64 = $R0.i64 - $R1.i64;
  $R0.i64 = fn_fib($R0.i64);
  $R1.i64 = n;
  $R2.i64 = 2;
  $R1.i64 = $R1.i64 - $R2.i64;
  $R1.i64 = fn_fib($R1.i64);
  $R0.i64 = $R0.i64 + $R1.i64;
  return $R0.i64;
}
```
